# Telegram MCP Bridge

Инструментарий, который подключает ваш личный аккаунт Telegram к [Model Context Protocol](https://github.com/modelcontextprotocol) и позволяет использовать его в ChatGPT. Сервер предоставляет инструменты для перечисления групп/каналов и полнотекстового поиска по историям чатов.

> ⚠️ **Важно.** Сервер работает от имени вашего личного аккаунта Telegram. Не запускайте его на недоверенных машинах и не делитесь сессией с третьими лицами.

## Возможности

- `telegram_list_groups` — выводит список групп и каналов, где состоит авторизованный пользователь.
- `telegram_search_messages` — ищет сообщения в выбранном чате по ключевым словам и возвращает как структурированный ответ, так и короткий текстовый дайджест.
- CLI-команды для интерактивного логина (`tgbot-mcp login`), проверки авторизации (`tgbot-mcp whoami`) и запуска MCP сервера (`tgbot-mcp run`).

## Требования

- Python 3.11 или новее.
- Зарегистрированное Telegram API приложение (получите `api_id` и `api_hash` на <https://my.telegram.org>). 

## Быстрый запуск

1. Создайте виртуальное окружение и установите пакет:

   ```bash
   python -m venv .venv
   source .venv/bin/activate
   pip install --upgrade pip
   pip install .
   ```

2. Задайте параметры доступа к Telegram. Проще всего — через файл `.env` в корне проекта:

   ```env
   TELEGRAM_API_ID=123456
   TELEGRAM_API_HASH=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
   TELEGRAM_SESSION_PATH=~/.tgbot_mcp/telegram.session
   ```

   При наличии строки сессии используйте `TELEGRAM_SESSION_STRING` вместо `TELEGRAM_SESSION_PATH`.

3. Выполните интерактивный вход один раз, чтобы создать сессию:

   ```bash
   tgbot-mcp login
   ```

   Укажите номер телефона, код подтверждения и (если настроено) пароль 2FA.

4. Проверьте авторизацию и при необходимости отладьте настройки:

   ```bash
   tgbot-mcp whoami
   ```

   В ответ появится информация о текущем аккаунте Telegram.

5. Запустите MCP сервер и держите терминал открытым, пока им пользуетесь:

   ```bash
   tgbot-mcp run
   ```

   ChatGPT в режиме MCP подключится к STDIO‑процессу и сможет вызывать инструменты.

## Установка

Вместо локального виртуального окружения можно установить CLI глобально через [pipx](https://pipx.pypa.io/):

```bash
pipx install .
```

При таком варианте команда `tgbot-mcp` станет доступна во всей системе, а сессию и `.env` всё равно можно хранить в домашнем каталоге.

## Настройка окружения

1. Создайте файл `.env` рядом с проектом или задайте переменные окружения напрямую:

   ```env
   TELEGRAM_API_ID=123456
   TELEGRAM_API_HASH=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
   TELEGRAM_SESSION_PATH=~/.tgbot_mcp/telegram.session
   ```

   Вместо `TELEGRAM_SESSION_PATH` можно использовать `TELEGRAM_SESSION_STRING`, если вы хотите хранить сессию в виде строки.

2. Выполните интерактивный вход, чтобы сохранить сессию:

   ```bash
   tgbot-mcp login
   ```

   Команда запросит номер телефона, код из Telegram и (при необходимости) пароль двухфакторной аутентификации. По окончании вы получите файл сессии либо строку, в зависимости от выбранных параметров.

3. Проверьте, что авторизация выполнена корректно:

   ```bash
   tgbot-mcp whoami
   ```

   В ответ должны отобразиться ID и имя вашего аккаунта.

## Запуск MCP сервера

Для интеграции с ChatGPT (в режиме Model Context Protocol) требуется STDIO-сервер. Запуск осуществляется одной командой:

```bash
tgbot-mcp run
```

Команда блокирует текущий терминал и ждёт подключения клиента MCP (например, браузерного ChatGPT).

## Подключение к ChatGPT

1. Откройте ChatGPT в браузере и перейдите в **Settings → Model Context Protocol → Add local server**.
2. В качестве команды запуска укажите `tgbot-mcp run` (при необходимости — полный путь к исполняемому файлу). ChatGPT автоматически создаст STDIO-процесс и подключится к инструментам.
3. После подключения в панели MCP появятся два инструмента: `telegram_list_groups` и `telegram_search_messages`. Теперь ChatGPT сможет вызывать их по необходимости.

## Развёртывание на Ubuntu VPS

Ниже — пример развёртывания на чистом сервере Ubuntu 22.04+. Выполняйте команды под пользователем с правами `sudo`.

1. Установите системные зависимости и создайте отдельного пользователя (опционально):

   ```bash
   sudo apt update
   sudo apt install -y git python3.11 python3.11-venv
   sudo adduser --disabled-password --gecos "" tgbot
   sudo usermod -aG sudo tgbot
   ```

   Если пользователь уже существует, достаточно установить пакеты.

2. Авторизуйтесь под созданным пользователем и подготовьте рабочий каталог:

   ```bash
   sudo -iu tgbot
   git clone https://github.com/<ваш-аккаунт>/<репозиторий>.git
   cd <репозиторий>
   python3.11 -m venv .venv
   source .venv/bin/activate
   pip install --upgrade pip
   pip install .
   ```

3. Создайте файл `.env` с параметрами Telegram и выполните вход:

   ```bash
   nano .env  # или любой другой редактор
   tgbot-mcp login
   ```

   Сессия сохранится по пути из `.env` (`TELEGRAM_SESSION_PATH` или `TELEGRAM_SESSION_STRING`).

4. Для долговременного запуска можно воспользоваться `tmux` или `systemd`. Пример через `tmux`:

   ```bash
   tmux new -s tgbot-mcp
   tgbot-mcp run
   ```

   Сессия `tmux` сохранит процесс при обрыве SSH. Для `systemd` создайте юнит с командой `ExecStart=/home/tgbot/<репозиторий>/.venv/bin/tgbot-mcp run`.

### Подключение ChatGPT к удалённому серверу

В окне добавления локального MCP сервера в ChatGPT укажите команду, запускающую сервер по SSH:

```bash
ssh -T tgbot@<ваш-vps> 'cd <репозиторий> && source .venv/bin/activate && tgbot-mcp run'
```

- Используйте SSH-ключи, чтобы избежать запроса пароля.
- Убедитесь, что переменные окружения и `.env` доступны на сервере.
- Если используете `systemd`, команда может быть проще: `ssh -T tgbot@<ваш-vps> 'systemctl --user start tgbot-mcp.service && journalctl --user -fu tgbot-mcp.service'`.

## Форматы инструментов

### telegram_list_groups

- **Вход:**
  - `limit` (int, по умолчанию 50) — максимальное число элементов.
  - `include_private` (bool, по умолчанию `true`) — включать ли приватные группы.
  - `include_channels` (bool, по умолчанию `false`) — включать ли каналы.
- **Выход:** массив объектов с полями `id`, `title`, `type`, `username`, а также метаданными о типе и публичности чата.

### telegram_search_messages

- **Вход:**
  - `chat` (string) — идентификатор, username, ссылка `t.me/...` или точное название диалога.
  - `query` (string) — текст запроса.
  - `limit` (int, по умолчанию 20) — количество сообщений в выдаче.
- **Выход:** сведения о чате и список найденных сообщений (ID, дата, отправитель, сниппет текста, ссылка).

## Советы по безопасности

- Ограничьте доступ к машине, на которой работает сервер.
- Храните файл сессии или строку в защищённом месте (например, используйте менеджер секретов).
- При необходимости быстро отозвать доступ — удалите файл сессии и выполните `tgbot-mcp login` заново.

## Лицензия

Проект распространяется по лицензии MIT (см. `pyproject.toml`).
